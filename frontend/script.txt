let comanda = [];

function formatarMoeda(valor) {
  return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

// Aumenta a quantidade de um item
function aumentarQuantidade(index) {
  comanda[index].quantidade += 1;
  atualizarComanda();
}

// Diminui ou remove o item
function diminuirQuantidade(index) {
  comanda[index].quantidade -= 1;
  if (comanda[index].quantidade <= 0) {
    comanda.splice(index, 1);
  }
  atualizarComanda();
}

// Alterna o campo de observa√ß√£o OU reabre o modal completo
function toggleObservacao(index) {
  const item = comanda[index];

  // Sandu√≠ches
  if (item.nome.includes('X-') || item.nome.includes('Burguer') || item.nome.includes('Salada') || item.nome.includes('Bacon')) {
    reabrirModalSanduiche(item, index);
  }
  // Batatas
  else if (item.nome.includes('Batata')) {
    reabrirModalBatata(item, index);
  }
  // Bebidas
  else if (item.nome.includes('Fanta') || item.nome.includes('Coca') || item.nome.includes('Sao Geraldo')) {
    reabrirModalRefrigerantes(item, index);
  }
  else if (item.nome.includes('Caju') || item.nome.includes('Goiaba') || item.nome.includes('Maracuj√°') || item.nome.includes('Vitamina')) {
    reabrirModalVitaminas(item, index);
  }
  else if (item.nome.includes('√Ågua') || item.nome.includes('Agua') || item.nome.includes('g√°s') || item.nome.includes('gas')) {
    reabrirModalAgua(item, index);
  }
  // Caso gen√©rico: s√≥ observa√ß√£o
  else {
    const obsDiv = document.getElementById(`obs-div-${index}`);
    if (!obsDiv) return;
    const isVisible = obsDiv.style.display === 'block';
    obsDiv.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
      setTimeout(() => {
        const input = document.getElementById(`obs-input-${index}`);
        if (input) input.focus();
      }, 100);
    }
  }
}

// Atualiza visualmente a lista de itens
function atualizarComanda() {
  const lista = document.getElementById('lista-itens');
  const totalEl = document.getElementById('total');
  lista.innerHTML = '';
  let total = 0;

  comanda.forEach((item, index) => {
    const precoItem = typeof item.preco === 'function' ? item.preco() : item.preco;
    const valorItem = precoItem * item.quantidade;
    total += valorItem;

    const li = document.createElement('li');
    li.className = 'list-group-item p-2';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'd-flex justify-content-between align-items-center mb-1';
    const nomeDiv = document.createElement('div');
    nomeDiv.innerHTML = `<strong>${item.nome}</strong>`;
    const acoesDiv = document.createElement('div');
    acoesDiv.className = 'd-flex align-items-center gap-2';

    const btnMenos = document.createElement('button');
    btnMenos.className = 'btn btn-sm btn-outline-danger';
    btnMenos.textContent = '‚Äì';
    btnMenos.onclick = () => diminuirQuantidade(index);

    const qtdSpan = document.createElement('span');
    qtdSpan.className = 'mx-2 fw-bold';
    qtdSpan.textContent = item.quantidade;

    const btnMais = document.createElement('button');
    btnMais.className = 'btn btn-sm btn-outline-success';
    btnMais.textContent = '+';
    btnMais.onclick = () => aumentarQuantidade(index);

    const btnObs = document.createElement('button');
    btnObs.className = 'btn btn-sm btn-outline-secondary';
    btnObs.innerHTML = '‚úèÔ∏è';
    btnObs.onclick = () => toggleObservacao(index);

    acoesDiv.appendChild(btnMenos);
    acoesDiv.appendChild(qtdSpan);
    acoesDiv.appendChild(btnMais);
    acoesDiv.appendChild(btnObs);
    headerDiv.appendChild(nomeDiv);
    headerDiv.appendChild(acoesDiv);

    // Pre√ßo do item
    const precoDiv = document.createElement('div');
    precoDiv.className = 'text-muted small mt-1';
    precoDiv.textContent = `${formatarMoeda(precoItem)} √ó ${item.quantidade} = ${formatarMoeda(valorItem)}`;

    // Detalhes das op√ß√µes (p√£o, ingredientes removidos, adicionais)
    let detalhesTexto = '';
    if (item.pao) {
      detalhesTexto += `P√£o: ${item.pao}`;
    }
    if (item.ingredientesRemovidos && item.ingredientesRemovidos.length > 0) {
      if (detalhesTexto) detalhesTexto += ' | ';
      detalhesTexto += `Sem: ${item.ingredientesRemovidos.join(', ')}`;
    }
    if (item.adicionais && item.adicionais.length > 0) {
      if (detalhesTexto) detalhesTexto += ' | ';
      detalhesTexto += `Adicionais: ${item.adicionais.map(a => a.nome).join(', ')}`;
    }

    const detalhesDiv = document.createElement('div');
    detalhesDiv.className = 'text-muted small mt-1';
    detalhesDiv.style.fontStyle = 'italic';
    detalhesDiv.textContent = detalhesTexto;

    // Campo de observa√ß√£o (s√≥ se houver texto digitado)
    const obsDiv = document.createElement('div');
    obsDiv.id = `obs-div-${index}`;
    obsDiv.className = 'mt-2';
    obsDiv.style.display = item.observacaoLivre ? 'block' : 'none';
    obsDiv.innerHTML = `
      <textarea 
        id="obs-input-${index}" 
        class="form-control form-control-sm" 
        placeholder="Observa√ß√£o adicional..."
        rows="2"
      >${item.observacaoLivre || ''}</textarea>
    `;

    const textarea = obsDiv.querySelector('textarea');
    textarea.addEventListener('input', function () {
      comanda[index].observacaoLivre = this.value;
    });

    li.appendChild(headerDiv);
    li.appendChild(precoDiv);
    if (detalhesTexto) li.appendChild(detalhesDiv);
    li.appendChild(obsDiv);
    lista.appendChild(li);
  });

  totalEl.textContent = formatarMoeda(total);
}

// Limpa toda a comanda
function limparComanda() {
  comanda = [];
  atualizarComanda();
}

// Fecha a conta
function fecharConta() {
  const selectMesa = document.getElementById('select-mesa');
  const numeroMesa = selectMesa.value.trim();
  if (!numeroMesa || isNaN(numeroMesa) || Number(numeroMesa) <= 0) {
    alert('Por favor, selecione uma mesa v√°lida.');
    return;
  }
  const subtotal = comanda.reduce((soma, item) => {
    const preco = typeof item.preco === 'function' ? item.preco() : item.preco;
    return soma + preco * item.quantidade;
  }, 0);
  const gorjeta = subtotal * 0.10;
  const totalComGorjeta = subtotal + gorjeta;

  document.getElementById('mesa-fechamento').textContent = numeroMesa;
  document.getElementById('subtotal-fechamento').textContent = formatarMoeda(subtotal);
  document.getElementById('gorjeta-fechamento').textContent = formatarMoeda(gorjeta);
  document.getElementById('total-com-gorjeta').textContent = formatarMoeda(totalComGorjeta);
  calcularPorPessoa();
  document.getElementById('tela-comanda').classList.add('d-none');
  document.getElementById('tela-fechamento').classList.remove('d-none');
}

// Volta para nova comanda
function voltarComanda() {
  comanda = [];
  document.getElementById('tela-fechamento').classList.add('d-none');
  document.getElementById('tela-comanda').classList.remove('d-none');
  atualizarComanda();
}

// Calcula valor por pessoa
function calcularPorPessoa() {
  const inputPessoas = document.getElementById('input-pessoas');
  const numPessoas = parseInt(inputPessoas.value) || 1;
  const subtotal = comanda.reduce((soma, item) => {
    const preco = typeof item.preco === 'function' ? item.preco() : item.preco;
    return soma + preco * item.quantidade;
  }, 0);
  const totalComGorjeta = subtotal * 1.10;
  const valorPorPessoa = totalComGorjeta / numPessoas;
  document.getElementById('valor-por-pessoa').textContent = formatarMoeda(valorPorPessoa);
}

// Imprime comanda e envia para cozinha
function imprimirComanda() {
  const selectMesa = document.getElementById('select-mesa');
  const numeroMesa = selectMesa.value;
  if (!numeroMesa) {
    alert('Por favor, selecione uma mesa.');
    selectMesa.focus();
    return;
  }

  // Prepara os itens para enviar ao back-end
  const itensParaEnviar = comanda.map(item => {
    const preco = typeof item.preco === 'function' ? item.preco() : item.preco;
    return {
      nome: item.nome,
      preco: preco,
      quantidade: item.quantidade,
      observacao: item.observacaoLivre || null
    };
  });

  fetch('http://localhost:8000/api/pedido-cozinha', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mesa_numero: parseInt(numeroMesa), itens: itensParaEnviar })
  })
    .then(response => response.json())
    .then(data => {
      let conteudoImpressao = `
      <html>
      <head><title>Comanda Cozinha - Nordest√¥</title>
        <style>body { font-family: Arial, sans-serif; padding: 20px; }
        h2 { color: #D4AF37; text-align: center; }
        .item { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #ccc; }
        .obs { color: #555; font-style: italic; margin-top: 4px; font-size: 0.9em; }
        </style>
      </head>
      <body>
        <h2>üïó PEDIDO COZINHA</h2>
        <p><strong>Mesa:</strong> ${numeroMesa}</p>
        <p><strong>Data:</strong> ${new Date().toLocaleString('pt-BR')}</p><hr>
    `;

      comanda.forEach(item => {
        const preco = typeof item.preco === 'function' ? item.preco() : item.preco;
        let detalhes = '';

        if (item.pao) {
          detalhes += `P√£o: ${item.pao}`;
        }
        if (item.ingredientesRemovidos && item.ingredientesRemovidos.length > 0) {
          if (detalhes) detalhes += ' | ';
          detalhes += `Sem: ${item.ingredientesRemovidos.join(', ')}`;
        }
        if (item.adicionais && item.adicionais.length > 0) {
          if (detalhes) detalhes += ' | ';
          detalhes += `Adicionais: ${item.adicionais.map(a => a.nome).join(', ')}`;
        }

        const obsFinal = item.observacaoLivre ? `Obs: ${item.observacaoLivre}` : '';

        conteudoImpressao += `
        <div class="item">
          <div><strong>${item.quantidade}x ${item.nome}</strong>${detalhes ? `<br><small>${detalhes}</small>` : ''}</div>
          ${obsFinal ? `<div class="obs">${obsFinal}</div>` : ''}
        </div>
      `;
      });

      conteudoImpressao += `
        <p style="margin-top: 30px; font-size: 0.9em; color: #888;">
          Nordest√¥ ‚Ä¢ Pedido enviado ao sistema
        </p>
      </body>
      </html>
    `;

      const janela = window.open('', '_blank');
      janela.document.write(conteudoImpressao);
      janela.document.close();
      janela.focus();
      setTimeout(() => janela.print(), 500);
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao enviar pedido para a cozinha.');
    });
}

// Carrega mesas dispon√≠veis
function carregarMesasDisponiveis() {
  fetch('http://localhost:8000/api/mesas-disponiveis')
    .then(response => response.json())
    .then(mesas => {
      const select = document.getElementById('select-mesa');
      select.innerHTML = '<option value="">-</option>';
      mesas.forEach(mesa => {
        const opt = document.createElement('option');
        opt.value = mesa.numero;
        opt.textContent = mesa.numero;
        select.appendChild(opt);
      });
    })
    .catch(console.error);
}
document.addEventListener('DOMContentLoaded', carregarMesasDisponiveis);

// =============== SANDU√çCHES ===============
let itemSelecionado = null;
function abrirModalSanduiche(nome, preco) {
  itemSelecionado = { nome, preco };
  document.querySelectorAll('input[name="pao"]').forEach(r => r.checked = false);
  document.getElementById('semSalada').checked = false;
  document.getElementById('semMolho').checked = false;
  document.querySelectorAll('.adicional').forEach(cb => cb.checked = false);
  document.getElementById('obsSanduiche').value = '';
  new bootstrap.Modal(document.getElementById('modalSanduiche')).show();
}

function salvarOpcoesSanduiche() {
  if (!itemSelecionado) return;

  const pao = document.querySelector('input[name="pao"]:checked')?.value || '';
  const ingredientesRemovidos = [];
  if (document.getElementById('semSalada').checked) ingredientesRemovidos.push('sem salada');
  if (document.getElementById('semMolho').checked) ingredientesRemovidos.push('sem molho');

  const adicionais = [];
  document.querySelectorAll('.adicional:checked').forEach(cb => {
    const nome = cb.nextElementSibling.textContent.split(' (+')[0];
    const preco = parseFloat(cb.getAttribute('data-preco'));
    adicionais.push({ nome, preco });
  });

  const obsLivre = document.getElementById('obsSanduiche').value.trim();

  comanda.push({
    nome: itemSelecionado.nome,
    precoBase: itemSelecionado.preco,
    pao: pao,
    ingredientesRemovidos: ingredientesRemovidos,
    adicionais: adicionais,
    observacaoLivre: obsLivre,
    quantidade: 1,
    get preco() {
      return this.precoBase + (this.adicionais?.reduce((s, a) => s + a.preco, 0) || 0);
    }
  });

  atualizarComanda();
  bootstrap.Modal.getInstance(document.getElementById('modalSanduiche')).hide();
}

// =============== BATATAS ===============
let itemBatataSelecionado = null;
function abrirModalBatata(nome, preco) {
  itemBatataSelecionado = { nome, preco };
  document.querySelectorAll('.adicional-batata').forEach(cb => cb.checked = false);
  document.getElementById('semMolho').checked = false;
  document.getElementById('obsBatata').value = '';
  new bootstrap.Modal(document.getElementById('modalBatata')).show();
}

function salvarOpcoesBatata() {
  if (!itemBatataSelecionado) return;

  const ingredientesRemovidos = [];
  if (document.getElementById('semMolho').checked) ingredientesRemovidos.push('Molho');
  if (document.getElementById('semSal').checked) ingredientesRemovidos.push('Sal');

  const adicionais = [];
  document.querySelectorAll('.adicional-batata:checked').forEach(cb => {
    const nome = cb.nextElementSibling.textContent.split(' (+')[0];
    const preco = parseFloat(cb.getAttribute('data-preco'));
    adicionais.push({ nome, preco });
  });

  const obsLivre = document.getElementById('obsBatata').value.trim();

  comanda.push({
    nome: itemBatataSelecionado.nome,
    precoBase: itemBatataSelecionado.preco,
    ingredientesRemovidos: ingredientesRemovidos,
    adicionais: adicionais,
    observacaoLivre: obsLivre,
    quantidade: 1,
    get preco() {
      return this.precoBase + (this.adicionais?.reduce((s, a) => s + a.preco, 0) || 0);
    }
  });

  atualizarComanda();
  bootstrap.Modal.getInstance(document.getElementById('modalBatata')).hide();
}

// =============== BEBIDAS (simples) ===============
function abrirModalRefrigerantes() {
  document.querySelectorAll('.bebida-refri').forEach(cb => cb.checked = false);
  document.getElementById('obsRefrigerantes').value = '';
  new bootstrap.Modal(document.getElementById('modalRefrigerantes')).show();
}
function salvarRefrigerantes() {
  const selecionados = [];
  document.querySelectorAll('.bebida-refri:checked').forEach(cb => {
    const nome = cb.nextElementSibling.textContent.split(' -')[0];
    const preco = parseFloat(cb.getAttribute('data-preco'));
    selecionados.push({ nome, preco });
  });
  const obs = document.getElementById('obsRefrigerantes').value.trim();
  if (selecionados.length === 0) { alert('Selecione pelo menos um refrigerante.'); return; }
  selecionados.forEach(item => {
    comanda.push({ nome: item.nome, preco: item.preco, observacaoLivre: obs, quantidade: 1 });
  });
  atualizarComanda();
  bootstrap.Modal.getInstance(document.getElementById('modalRefrigerantes')).hide();
}

function abrirModalVitaminas() {
  document.querySelectorAll('.bebida-vitamina').forEach(cb => cb.checked = false);
  document.getElementById('obsVitaminas').value = '';
  new bootstrap.Modal(document.getElementById('modalVitaminas')).show();
}
function salvarVitaminas() {
  const selecionados = [];
  document.querySelectorAll('.bebida-vitamina:checked').forEach(cb => {
    const nome = cb.nextElementSibling.textContent.split(' -')[0];
    const preco = parseFloat(cb.getAttribute('data-preco'));
    selecionados.push({ nome, preco });
  });
  const obs = document.getElementById('obsVitaminas').value.trim();
  if (selecionados.length === 0) { alert('Selecione pelo menos uma vitamina.'); return; }
  selecionados.forEach(item => {
    comanda.push({ nome: item.nome, preco: item.preco, observacaoLivre: obs, quantidade: 1 });
  });
  atualizarComanda();
  bootstrap.Modal.getInstance(document.getElementById('modalVitaminas')).hide();
}

function abrirModalAgua() {
  document.querySelectorAll('.bebida-agua').forEach(cb => cb.checked = false);
  document.getElementById('obsAgua').value = '';
  new bootstrap.Modal(document.getElementById('modalAgua')).show();
}
function salvarAgua() {
  const selecionados = [];
  document.querySelectorAll('.bebida-agua:checked').forEach(cb => {
    const nome = cb.nextElementSibling.textContent.split(' -')[0];
    const preco = parseFloat(cb.getAttribute('data-preco'));
    selecionados.push({ nome, preco });
  });
  const obs = document.getElementById('obsAgua').value.trim();
  if (selecionados.length === 0) { alert('Selecione pelo menos uma op√ß√£o de √°gua.'); return; }
  selecionados.forEach(item => {
    comanda.push({ nome: item.nome, preco: item.preco, observacaoLivre: obs, quantidade: 1 });
  });
  atualizarComanda();
  bootstrap.Modal.getInstance(document.getElementById('modalAgua')).hide();
}

// =============== REABRIR MODAIS PARA EDI√á√ÉO ===============
function reabrirModalSanduiche(item, index) {
  window.itemEmEdicao = { item, index };

  document.querySelectorAll('input[name="pao"]').forEach(r => r.checked = false);
  document.getElementById('semSalada').checked = false;
  document.getElementById('semMolho').checked = false;
  document.querySelectorAll('.adicional').forEach(cb => cb.checked = false);
  document.getElementById('obsSanduiche').value = item.observacaoLivre || '';

  if (item.pao === 'P√£o √Årabe') document.getElementById('paoArabe').checked = true;
  if (item.pao === 'P√£o Bola') document.getElementById('paoBola').checked = true;
  if (item.ingredientesRemovidos?.includes('sem salada')) document.getElementById('semSalada').checked = true;
  if (item.ingredientesRemovidos?.includes('sem molho')) document.getElementById('semMolho').checked = true;

  (item.adicionais || []).forEach(ad => {
    if (ad.nome.includes('Bacon extra')) document.getElementById('baconExtra').checked = true;
    if (ad.nome.includes('Carne extra')) document.getElementById('carneExtra').checked = true;
  });

  const modal = new bootstrap.Modal(document.getElementById('modalSanduiche'));
  const salvarOriginal = window.salvarOpcoesSanduiche;
  window.salvarOpcoesSanduiche = function () {
    const { item, index } = window.itemEmEdicao;

    const pao = document.querySelector('input[name="pao"]:checked')?.value || '';
    const ingredientesRemovidos = [];
    if (document.getElementById('semSalada').checked) ingredientesRemovidos.push('sem salada');
    if (document.getElementById('semMolho').checked) ingredientesRemovidos.push('sem molho');

    const novosAdicionais = [];
    document.querySelectorAll('.adicional:checked').forEach(cb => {
      const nome = cb.nextElementSibling.textContent.split(' (+')[0];
      const preco = parseFloat(cb.getAttribute('data-preco'));
      novosAdicionais.push({ nome, preco });
    });

    const obsLivre = document.getElementById('obsSanduiche').value.trim();

    item.pao = pao;
    item.ingredientesRemovidos = ingredientesRemovidos;
    item.adicionais = novosAdicionais;
    item.observacaoLivre = obsLivre;

    atualizarComanda();
    window.salvarOpcoesSanduiche = salvarOriginal;
    delete window.itemEmEdicao;
    modal.hide();
  };
  modal.show();
}

function reabrirModalBatata(item, index) {
  window.itemEmEdicao = { item, index };

  document.querySelectorAll('.adicional-batata').forEach(cb => cb.checked = false);
  document.getElementById('semMolho').checked = false;
  document.getElementById('semSal').checked = false;
  document.getElementById('obsBatata').value = item.observacaoLivre || '';

  if (item.ingredientesRemovidos?.includes('Molho')) document.getElementById('semMolho').checked = true;
  if (item.ingredientesRemovidos?.includes('Sal')) document.getElementById('semSal').checked = true;
  (item.adicionais || []).forEach(ad => {
    if (ad.nome.includes('Queijo Cheddar')) document.getElementById('queijoBatata').checked = true;
    if (ad.nome.includes('Bacon')) document.getElementById('baconBatata').checked = true;
  });

  const modal = new bootstrap.Modal(document.getElementById('modalBatata'));
  const salvarOriginal = window.salvarOpcoesBatata;
  window.salvarOpcoesBatata = function () {
    const { item, index } = window.itemEmEdicao;

    const ingredientesRemovidos = [];
    if (document.getElementById('semMolho').checked) ingredientesRemovidos.push('Molho');
    if (document.getElementById('semSal').checked) ingredientesRemovidos.push('Sal');

    const novosAdicionais = [];
    document.querySelectorAll('.adicional-batata:checked').forEach(cb => {
      const nome = cb.nextElementSibling.textContent.split(' (+')[0];
      const preco = parseFloat(cb.getAttribute('data-preco'));
      novosAdicionais.push({ nome, preco });
    });

    const obsLivre = document.getElementById('obsBatata').value.trim();

    item.ingredientesRemovidos = ingredientesRemovidos;
    item.adicionais = novosAdicionais;
    item.observacaoLivre = obsLivre;

    atualizarComanda();
    window.salvarOpcoesBatata = salvarOriginal;
    delete window.itemEmEdicao;
    modal.hide();
  };
  modal.show();
}

// === REABRIR MODAL REFRIGERANTES ===
function reabrirModalRefrigerantes(item, index) {
  window.itemEmEdicao = { item, index };
  
  // Limpa e preenche checkboxes
  document.querySelectorAll('.bebida-refri').forEach(cb => {
    cb.checked = item.nome.includes(cb.nextElementSibling.textContent.split(' -')[0]);
  });
  
  document.getElementById('obsRefrigerantes').value = item.observacaoLivre || '';

  const modal = new bootstrap.Modal(document.getElementById('modalRefrigerantes'));
  const salvarOriginal = window.salvarRefrigerantes;
  window.salvarRefrigerantes = function() {
    const { item, index } = window.itemEmEdicao;
    
    const selecionados = [];
    document.querySelectorAll('.bebida-refri:checked').forEach(cb => {
      const nome = cb.nextElementSibling.textContent.split(' -')[0];
      const preco = parseFloat(cb.getAttribute('data-preco'));
      selecionados.push({ nome, preco });
    });
    const obs = document.getElementById('obsRefrigerantes').value.trim();

    // Remove o item antigo
    comanda.splice(index, 1);
    
    // Adiciona os novos itens (pode ser mais de um)
    selecionados.forEach(sel => {
      comanda.push({
        nome: sel.nome,
        preco: sel.preco,
        observacaoLivre: obs,
        quantidade: 1
      });
    });

    atualizarComanda();
    window.salvarRefrigerantes = salvarOriginal;
    delete window.itemEmEdicao;
    modal.hide();
  };
  modal.show();
}

// === REABRIR MODAL VITAMINAS ===
function reabrirModalVitaminas(item, index) {
  window.itemEmEdicao = { item, index };
  
  document.querySelectorAll('.bebida-vitamina').forEach(cb => {
    cb.checked = item.nome.includes(cb.nextElementSibling.textContent.split(' -')[0]);
  });
  document.getElementById('obsVitaminas').value = item.observacaoLivre || '';

  const modal = new bootstrap.Modal(document.getElementById('modalVitaminas'));
  const salvarOriginal = window.salvarVitaminas;
  window.salvarVitaminas = function() {
    const { item, index } = window.itemEmEdicao;
    
    const selecionados = [];
    document.querySelectorAll('.bebida-vitamina:checked').forEach(cb => {
      const nome = cb.nextElementSibling.textContent.split(' -')[0];
      const preco = parseFloat(cb.getAttribute('data-preco'));
      selecionados.push({ nome, preco });
    });
    const obs = document.getElementById('obsVitaminas').value.trim();

    comanda.splice(index, 1);
    selecionados.forEach(sel => {
      comanda.push({
        nome: sel.nome,
        preco: sel.preco,
        observacaoLivre: obs,
        quantidade: 1
      });
    });

    atualizarComanda();
    window.salvarVitaminas = salvarOriginal;
    delete window.itemEmEdicao;
    modal.hide();
  };
  modal.show();
}

// === REABRIR MODAL √ÅGUA ===
function reabrirModalAgua(item, index) {
  window.itemEmEdicao = { item, index };
  
  document.querySelectorAll('.bebida-agua').forEach(cb => {
    cb.checked = item.nome.includes(cb.nextElementSibling.textContent.split(' -')[0]);
  });
  document.getElementById('obsAgua').value = item.observacaoLivre || '';

  const modal = new bootstrap.Modal(document.getElementById('modalAgua'));
  const salvarOriginal = window.salvarAgua;
  window.salvarAgua = function() {
    const { item, index } = window.itemEmEdicao;
    
    const selecionados = [];
    document.querySelectorAll('.bebida-agua:checked').forEach(cb => {
      const nome = cb.nextElementSibling.textContent.split(' -')[0];
      const preco = parseFloat(cb.getAttribute('data-preco'));
      selecionados.push({ nome, preco });
    });
    const obs = document.getElementById('obsAgua').value.trim();

    comanda.splice(index, 1);
    selecionados.forEach(sel => {
      comanda.push({
        nome: sel.nome,
        preco: sel.preco,
        observacaoLivre: obs,
        quantidade: 1
      });
    });

    atualizarComanda();
    window.salvarAgua = salvarOriginal;
    delete window.itemEmEdicao;
    modal.hide();
  };
  modal.show();
}